<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://pchaganti.github.io/assets/css/bookshelf.main.css"
    />
    <link
      rel="stylesheet"
      href="https://pchaganti.github.io/assets/css/bookshelf.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:ital,wght@0,100..900;1,100..900&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <style>
      .loading {
        text-align: center;
        padding: 20px;
      }

      .year-nav {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .year-btn {
        padding: 8px 16px;
        border: none;
        background: #eee;
        cursor: pointer;
        border-radius: 4px;
      }

      .year-btn.active {
        background: #333;
        color: white;
      }

      .book-count {
        font-size: 0.9em;
        color: #666;
        margin-left: 10px;
      }

      .search-box {
        width: 100%;
        max-width: 300px;
        padding: 8px;
        margin: 20px 0;
      }

      .retry-btn {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .bookshelf {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
      }

      .book {
        width: 150px; /* Standard book cover width */
        height: 225px; /* 3:2 aspect ratio */
        margin: 10px;
        position: relative;
        transition: transform 0.3s ease;
      }

      .cover {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Remove unused styles */
      .spine,
      .spine-title,
      .spine-author,
      .top,
      .spine-patterns,
      .spine-colors {
        display: none;
      }

      /* Optional hover effect */
      .book:hover {
        transform: translateY(-5px);
      }
    </style>
  </head>

  <body>
    <main>
      <h1 id="my-bookshelf">pchaganti | biblio</h1>
      <h4 style="font-style: italic">
        A man ought to read just as inclination leads him; for what he reads as
        a task will do him little good - Samuel Johnson, 1742
      </h4>
      <input
        type="search"
        class="search-box"
        placeholder="Search books..."
        id="searchBox"
      />
      <div class="year-nav" id="yearNav"></div>
      <div id="books-container"></div>
      <br />
      <script>
        async function loadBooks() {
          const years = ["2024", "2023"];
          const container = document.getElementById("books-container");
          const yearNav = document.getElementById("yearNav");
          console.log("Starting to load books...");

          // Create year navigation
          years.forEach((year) => {
            const btn = document.createElement("button");
            btn.className = "year-btn";
            btn.textContent = year;
            btn.onclick = () => filterByYear(year);
            yearNav.appendChild(btn);
          });

          // Add loading state
          container.innerHTML = '<div class="loading">Loading books...</div>';

          for (const year of years) {
            console.log(`Loading year: ${year}`);
            const yearSection = document.createElement("div");
            yearSection.style.marginTop = "32px";
            yearSection.dataset.year = year;

            const yearHeader = document.createElement("h2");
            yearHeader.className = "yearRead";
            yearHeader.textContent = year;
            yearSection.appendChild(yearHeader);

            try {
              const response = await fetch(`./books/${year}.html`);
              if (!response.ok)
                throw new Error(`HTTP error! status: ${response.status}`);
              const html = await response.text();
              console.log(`Loaded HTML for ${year}:`, html.substring(0, 100));
              yearSection.insertAdjacentHTML("beforeend", html);
              container.appendChild(yearSection);
            } catch (error) {
              console.error(`Error loading books for ${year}:`, error);
              yearSection.innerHTML += `
                <div class="error">
                    Failed to load books for ${year}
                    <button class="retry-btn" onclick="retryLoad('${year}')">Retry</button>
                </div>
            `;
            }
          }

          // Remove loading state if it exists
          const loadingDiv = container.querySelector(".loading");
          if (loadingDiv) loadingDiv.remove();
        }

        function filterByYear(selectedYear) {
          document.querySelectorAll(".year-btn").forEach((btn) => {
            btn.classList.toggle("active", btn.textContent === selectedYear);
          });

          document.querySelectorAll("[data-year]").forEach((section) => {
            section.style.display =
              selectedYear === "all" || section.dataset.year === selectedYear
                ? "block"
                : "none";
          });
        }

        function searchBooks(query) {
          const normalizedQuery = query.toLowerCase();
          document.querySelectorAll('.book').forEach((book) => {
              // Use data attributes instead of DOM elements
              const title = book.dataset.title?.toLowerCase() || '';
              const author = book.dataset.author?.toLowerCase() || '';
              const isMatch = title.includes(normalizedQuery) || 
                             author.includes(normalizedQuery);
              book.style.display = isMatch ? "block" : "none";
          });
        }

        async function retryLoad(year) {
          const section = document.querySelector(`[data-year="${year}"]`);
          if (section) {
            section.innerHTML = '<div class="loading">Retrying...</div>';
            try {
              const response = await fetch(`books/${year}.html`);
              const html = await response.text();
              section.innerHTML = html;
            } catch (error) {
              console.error(`Retry failed for ${year}:`, error);
              section.innerHTML = `
              <div class="error">
                Retry failed for ${year}
                <button class="retry-btn" onclick="retryLoad('${year}')">Retry</button>
              </div>
            `;
            }
          }
        }

        document.addEventListener("DOMContentLoaded", loadBooks);
        document.getElementById("searchBox").addEventListener("input", (e) => {
          searchBooks(e.target.value);
        });

        function stylizeBooks() {
          const spines = document.querySelectorAll(".spine");
          const availablePatterns = ["argyle", "tartan", "pyramid", "stairs"];
          const availableColours = [
            "maroon",
            "darkgreen",
            "darkolivegreen",
            "brown",
            "saddlebrown",
            "sienna",
            "midnightblue",
          ];

          spines.forEach((spine) => {
            // Set random height
            const randomHeight = getRandomInt(220, 290);
            spine.style.height = `${randomHeight}px`;
            spine.style.top = `${280 - randomHeight}px`;

            // Add pattern class
            const pattern = randomChoice(availablePatterns);
            spine.classList.add(`spine-${pattern}`);

            // Add color class
            const color = randomChoice(availableColours);
            spine.classList.add(`spine-${color}`);
          });
        }

        document.addEventListener("DOMContentLoaded", () => {
          loadBooks().then(() => {
            stylizeBooks();
          });
        });

        function getRandomInt(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function randomChoice(array) {
          return array[Math.floor(Math.random() * array.length)];
        }

        let spines = Object.values(document.getElementsByClassName("spine"));
        let covers = Object.values(document.getElementsByClassName("cover"));
        let tops = Object.values(document.getElementsByClassName("top"));

        let availablePatterns = ["argyle", "tartan", "pyramid", "stairs"]; // we could probably get these programatically
        let availableColours = [
          "maroon",
          "darkgreen",
          "darkolivegreen",
          "brown",
          "saddlebrown",
          "sienna",
          "midnightblue",
        ];

        // assign a random height, pattern and colour to each book
        spines.map(function (s, i) {
          let randomHeight = getRandomInt(220, 290);
          s.style.height = `${randomHeight}px`;
          s.style.top = `${280 - randomHeight}px`;

          let randomPattern = randomChoice(availablePatterns);
          s.style.backgroundImage = `var(--spine-${randomPattern})`;

          let randomColor = randomChoice(availableColours);
          s.style.backgroundColor = randomColor;

          covers[i].style.height = `${randomHeight}px`;
          covers[i].style.top = `${280 - randomHeight}px`;

          tops[i].style.top = `${280 - randomHeight}px`;
        });
      </script>
    </main>
    <br /><br /><br />
  </body>
</html>
